import { poolPromise } from './db.js';

(async () => {
  try {
    const pool = await poolPromise;

    const sql = `SELECT [TechnicianStatusRequest].[Id], [TechnicianStatusRequest].[technician_id] AS [TechnicianId], [TechnicianStatusRequest].[requested_by] AS [RequestedBy], [TechnicianStatusRequest].[request_type] AS [RequestType], [TechnicianStatusRequest].[status] AS [Status], [TechnicianStatusRequest].[requested_at] AS [RequestedAt], [TechnicianStatusRequest].[approved_at] AS [ApprovedAt], [TechnicianStatusRequest].[approved_by] AS [ApprovedBy], [TechnicianStatusRequest].[notes] AS [Notes], [TechnicianStatusRequest].[technician_name] AS [TechnicianName], [TechnicianStatusRequest].[technician_mobile] AS [TechnicianMobile], [TechnicianStatusRequest].[technician_email] AS [TechnicianEmail], [Technician].[Id] AS [Technician.Id], [Technician].[ServiceCentreId] AS [Technician.ServiceCentreId], [Technician].[TechnicianName] AS [Technician.Name], [Technician].[MobileNo] AS [Technician.Mobile], [Technician].[Email] AS [Technician.Email], [Technician].[Active] AS [Technician.Status], [Technician].[CreatedAt] AS [Technician.CreatedAt], [Technician->ServiceCentre].[Id] AS [Technician.ServiceCentre.Id], [Technician->ServiceCentre].[CenterName] AS [Technician.ServiceCentre.CenterName], [Technician->ServiceCentre].[Address] AS [Technician.ServiceCentre.Address], [Technician->ServiceCentre].[City] AS [Technician.ServiceCentre.City], [Technician->ServiceCentre].[State] AS [Technician.ServiceCentre.State], [Technician->ServiceCentre].[PinCode] AS [Technician.ServiceCentre.PinCode], [Technician->ServiceCentre].[Latitude] AS [Technician.ServiceCentre.Latitude], [Technician->ServiceCentre].[Longitude] AS [Technician.ServiceCentre.Longitude], [Technician->ServiceCentre].[ContactPerson] AS [Technician.ServiceCentre.ContactPerson], [Technician->ServiceCentre].[Phone] AS [Technician.ServiceCentre.Phone], [Technician->ServiceCentre].[BranchId] AS [Technician.ServiceCentre.BranchId], [Technician->ServiceCentre].[CreatedAt] AS [Technician.ServiceCentre.CreatedAt], [Requester].[UserID] AS [Requester.UserID], [Requester].[Username] AS [Requester.Username], [Requester].[Password] AS [Requester.Password], [Requester].[Role] AS [Requester.Role], [Requester].[Email] AS [Requester.Email], [Requester].[BranchId] AS [Requester.BranchId], [Requester].[CenterId] AS [Requester.CenterId], [Requester->ServiceCentre].[Id] AS [Requester.ServiceCentre.Id], [Requester->ServiceCentre].[CenterName] AS [Requester.ServiceCentre.CenterName], [Requester->ServiceCentre].[Address] AS [Requester.ServiceCentre.Address], [Requester->ServiceCentre].[City] AS [Requester.ServiceCentre.City], [Requester->ServiceCentre].[State] AS [Requester.ServiceCentre.State], [Requester->ServiceCentre].[PinCode] AS [Requester.ServiceCentre.PinCode], [Requester->ServiceCentre].[Latitude] AS [Requester.ServiceCentre.Latitude], [Requester->ServiceCentre].[Longitude] AS [Requester.ServiceCentre.Longitude], [Requester->ServiceCentre].[ContactPerson] AS [Requester.ServiceCentre.ContactPerson], [Requester->ServiceCentre].[Phone] AS [Requester.ServiceCentre.Phone], [Requester->ServiceCentre].[BranchId] AS [Requester.ServiceCentre.BranchId], [Requester->ServiceCentre].[CreatedAt] AS [Requester.ServiceCentre.CreatedAt] FROM [technician_status_requests] AS [TechnicianStatusRequest] LEFT OUTER JOIN [technicians] AS [Technician] ON [TechnicianStatusRequest].[technician_id] = [Technician].[Id] LEFT OUTER JOIN [ServiceCenters] AS [Technician->ServiceCentre] ON [Technician].[ServiceCentreId] = [Technician->ServiceCentre].[Id] LEFT OUTER JOIN [users] AS [Requester] ON [TechnicianStatusRequest].[requested_by] = [Requester].[UserID] LEFT OUTER JOIN [ServiceCenters] AS [Requester->ServiceCentre] ON [Requester].[CenterId] = [Requester->ServiceCentre].[Id] WHERE ([Technician].[ServiceCentreId] IN (2) OR ([Requester].[CenterId] IN (2) AND [TechnicianStatusRequest].[technician_id] IS NULL)) AND [TechnicianStatusRequest].[status] = N'pending';`;

    const result = await pool.request().query(sql);
    console.log('Query executed successfully');
    console.log('Rows:', result.recordset.length);

  } catch(e) {
    console.error('Error:', e.message);
  }
})();
# Close Call Process - Visual Flow Diagram

## ðŸ“Š Complete Visual Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        TECHNICIAN CLOSES CALL                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
                    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
                    â”ƒ POST /call/:id/close â”ƒ
                    â”ƒ {call_id: 456,     â”ƒ
                    â”ƒ  tech_id: 501,     â”ƒ
                    â”ƒ  status: CLOSED}   â”ƒ
                    â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
                                  â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â–¼                 â–¼                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ STEP 1       â”‚  â”‚ STEP 2       â”‚  â”‚ STEP 3       â”‚
        â”‚ READ         â”‚  â”‚ CREATE       â”‚  â”‚ CREATE       â”‚
        â”‚ Spares Used  â”‚  â”‚ Stock        â”‚  â”‚ Goods Items  â”‚
        â”‚              â”‚  â”‚ Movement     â”‚  â”‚              â”‚
        â”‚ SELECT       â”‚  â”‚ (GOODâ†’       â”‚  â”‚ INSERT INTO  â”‚
        â”‚ from         â”‚  â”‚ DEFECTIVE)   â”‚  â”‚ goods_       â”‚
        â”‚ call_spare   â”‚  â”‚              â”‚  â”‚ movement_    â”‚
        â”‚ _usage       â”‚  â”‚ Used Qty: 3  â”‚  â”‚ items (1 row â”‚
        â”‚ WHERE        â”‚  â”‚              â”‚  â”‚ per spare)   â”‚
        â”‚ used_qty > 0 â”‚  â”‚ Movement ID: â”‚  â”‚              â”‚
        â”‚              â”‚  â”‚ 5001         â”‚  â”‚ Spare 100:1  â”‚
        â”‚ Found 2:     â”‚  â”‚              â”‚  â”‚ Spare 101:2  â”‚
        â”‚ Spare 100:1  â”‚  â”‚ Status:      â”‚  â”‚ Condition:   â”‚
        â”‚ Spare 101:2  â”‚  â”‚ completed    â”‚  â”‚ defective    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â–¼                 â–¼                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ STEP 4       â”‚  â”‚ STEP 5       â”‚  â”‚ STEP 6       â”‚
        â”‚ UPDATE       â”‚  â”‚ UPDATE       â”‚  â”‚ UPDATE       â”‚
        â”‚ Spare        â”‚  â”‚ TAT Tracking â”‚  â”‚ Call Status  â”‚
        â”‚ Inventory    â”‚  â”‚              â”‚  â”‚              â”‚
        â”‚              â”‚  â”‚ SET          â”‚  â”‚ UPDATE calls â”‚
        â”‚ For each     â”‚  â”‚ tat_end_time â”‚  â”‚ SET status = â”‚
        â”‚ spare:       â”‚  â”‚ = NOW        â”‚  â”‚ 'CLOSED'     â”‚
        â”‚              â”‚  â”‚              â”‚  â”‚              â”‚
        â”‚ Spare 100:   â”‚  â”‚ SET          â”‚  â”‚ Call 456:    â”‚
        â”‚ qty_good:    â”‚  â”‚ tat_status = â”‚  â”‚ CLOSED âœ…    â”‚
        â”‚ 10â†’9 (-1)    â”‚  â”‚ 'completed'  â”‚  â”‚              â”‚
        â”‚ qty_def:     â”‚  â”‚              â”‚  â”‚ Updated_at:  â”‚
        â”‚ 5â†’6 (+1)     â”‚  â”‚ DATEDIFF():  â”‚  â”‚ NOW          â”‚
        â”‚              â”‚  â”‚ 30 minutes   â”‚  â”‚              â”‚
        â”‚ Spare 101:   â”‚  â”‚              â”‚  â”‚              â”‚
        â”‚ qty_good:    â”‚  â”‚ total_hold_  â”‚  â”‚              â”‚
        â”‚ 8â†’6 (-2)     â”‚  â”‚ minutes: 10  â”‚  â”‚              â”‚
        â”‚ qty_def:     â”‚  â”‚              â”‚  â”‚              â”‚
        â”‚ 3â†’5 (+2)     â”‚  â”‚ work_time:   â”‚  â”‚              â”‚
        â”‚              â”‚  â”‚ 30-10=20m    â”‚  â”‚              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ RESPONSE (Status 200)    â”‚
                    â”‚                          â”‚
                    â”‚ {                        â”‚
                    â”‚   "ok": true,            â”‚
                    â”‚   "status": "CLOSED",    â”‚
                    â”‚   "stock_movement_id":   â”‚
                    â”‚   5001,                  â”‚
                    â”‚   "inventory_updates":   â”‚
                    â”‚   2,                     â”‚
                    â”‚   "tat_end_time": NOW    â”‚
                    â”‚ }                        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â–¼                 â–¼                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ stock_       â”‚  â”‚ goods_       â”‚  â”‚ spare_       â”‚
        â”‚ movement âœ…  â”‚  â”‚ movement_    â”‚  â”‚ inventory âœ… â”‚
        â”‚              â”‚  â”‚ items âœ…     â”‚  â”‚              â”‚
        â”‚ ID: 5001     â”‚  â”‚              â”‚  â”‚ Spare 100:   â”‚
        â”‚ Type:        â”‚  â”‚ 2 items:     â”‚  â”‚ good=9       â”‚
        â”‚ DEFECTIVE    â”‚  â”‚              â”‚  â”‚ defect=6     â”‚
        â”‚              â”‚  â”‚ spid:100     â”‚  â”‚              â”‚
        â”‚ From:        â”‚  â”‚ qty:1        â”‚  â”‚ Spare 101:   â”‚
        â”‚ GOOD         â”‚  â”‚ cond:def     â”‚  â”‚ good=6       â”‚
        â”‚              â”‚  â”‚              â”‚  â”‚ defect=5     â”‚
        â”‚ To:          â”‚  â”‚ spid:101     â”‚  â”‚              â”‚
        â”‚ DEFECTIVE    â”‚  â”‚ qty:2        â”‚  â”‚ Location:    â”‚
        â”‚              â”‚  â”‚ cond:def     â”‚  â”‚ tech 501 âœ…  â”‚
        â”‚ Qty: 3       â”‚  â”‚              â”‚  â”‚              â”‚
        â”‚              â”‚  â”‚              â”‚  â”‚              â”‚
        â”‚ Ref:         â”‚  â”‚ Movement:    â”‚  â”‚              â”‚
        â”‚ CALL-456     â”‚  â”‚ 5001         â”‚  â”‚              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ”„ Data Transformation View

### BEFORE Call Closure
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Technician 501 Inventory                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                â”‚
â”‚ Spare 100 (COMPRESSOR)                        â”‚
â”‚ â”œâ”€ Good Qty: 10                               â”‚
â”‚ â””â”€ Defective Qty: 5                           â”‚
â”‚   Total: 15                                   â”‚
â”‚                                                â”‚
â”‚ Spare 101 (PUMP)                              â”‚
â”‚ â”œâ”€ Good Qty: 8                                â”‚
â”‚ â””â”€ Defective Qty: 3                           â”‚
â”‚   Total: 11                                   â”‚
â”‚                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Call 456 Status                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Status: OPEN                                  â”‚
â”‚ Updated: 2026-02-28 10:00:00                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### AFTER Call Closure
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Technician 501 Inventory âœ… UPDATED            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                â”‚
â”‚ Spare 100 (COMPRESSOR)                        â”‚
â”‚ â”œâ”€ Good Qty: 9      â† decreased by 1         â”‚
â”‚ â””â”€ Defective Qty: 6 â† increased by 1         â”‚
â”‚   Total: 15 (unchanged)                       â”‚
â”‚                                                â”‚
â”‚ Spare 101 (PUMP)                              â”‚
â”‚ â”œâ”€ Good Qty: 6      â† decreased by 2         â”‚
â”‚ â””â”€ Defective Qty: 5 â† increased by 2         â”‚
â”‚   Total: 11 (unchanged)                       â”‚
â”‚                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Call 456 Status âœ… UPDATED                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Status: CLOSED    â† from OPEN                 â”‚
â”‚ Updated: 2026-02-28 11:00:00 â† new timestamp â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stock Movement âœ… CREATED                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ID: 5001                                      â”‚
â”‚ Type: DEFECTIVE_MARKING                       â”‚
â”‚ From: Technician 501 [GOOD]                   â”‚
â”‚ To: Technician 501 [DEFECTIVE]                â”‚
â”‚ Qty: 3 units total                            â”‚
â”‚ Reference: CALL-456                           â”‚
â”‚ Status: completed                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TAT Tracking âœ… COMPLETED                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ tat_start_time: 2026-02-28 10:30:00          â”‚
â”‚ tat_end_time: 2026-02-28 11:00:00 â† SET NOW â”‚
â”‚ tat_status: completed   â† from in_progress   â”‚
â”‚ total_tat_minutes: 30 (calculated)           â”‚
â”‚ total_hold_minutes: 10 (from holds)          â”‚
â”‚ work_minutes: 20 (30-10)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ“ Transaction Timeline

```
Time         Event                      Data Changed
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
10:30:00 â†’   Call 456 starts (TAT)     tat_start_time = 10:30
              
10:35:00 â†’   Hold created              hold_start_time = 10:35
            (blocked, waiting)          
              
10:45:00 â†’   Hold resolved              hold_end_time = 10:45
              (spare arrived)            hold_duration = 10 min

11:00:00 â†’   Call CLOSED â­             âœ… MAIN STEP:
            POST /call/:id/close        - tat_end_time = 11:00
                                         - tat_status = completed
                                         - stock movement created
                                         - inventory updated
                                         - call status = CLOSED

RESULT:
  Total TAT: 30 minutes (11:00 - 10:30)
  Hold Time: 10 minutes
  Work Time: 20 minutes (excluding hold)
  Stock: 3 units moved GOODâ†’DEFECTIVE âœ…
```

---

## ðŸŽ¯ Request-Response Cycle

```
CLIENT (Postman)                 SERVER                   DATABASE
     â”‚                             â”‚                         â”‚
     â”‚  POST /call/456/close       â”‚                         â”‚
     â”‚  {call_id:456, tech:501}    â”‚                         â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                         â”‚
     â”‚                             â”‚                         â”‚
     â”‚                             â”‚  1. SELECT spares      â”‚
     â”‚                             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                             â”‚  (used_qty > 0)        â”‚
     â”‚                             â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                             â”‚  Got 2 spares          â”‚
     â”‚                             â”‚  Qty total: 3          â”‚
     â”‚                             â”‚                        â”‚
     â”‚                             â”‚  2. INSERT stock_mov   â”‚
     â”‚                             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                             â”‚  GOODâ†’DEFECTIVE        â”‚
     â”‚                             â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                             â”‚  Movement ID: 5001 âœ…  â”‚
     â”‚                             â”‚                        â”‚
     â”‚                             â”‚  3. INSERT goods_items â”‚
     â”‚                             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                             â”‚  2 rows (per spare)    â”‚
     â”‚                             â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                             â”‚  Items created âœ…      â”‚
     â”‚                             â”‚                        â”‚
     â”‚                             â”‚  4. UPDATE inventory   â”‚
     â”‚                             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                             â”‚  qty_good--, qty_def++ â”‚
     â”‚                             â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                             â”‚  2 rows updated âœ…     â”‚
     â”‚                             â”‚                        â”‚
     â”‚                             â”‚  5. UPDATE TAT         â”‚
     â”‚                             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                             â”‚  tat_end_time = NOW    â”‚
     â”‚                             â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                             â”‚  TAT completed âœ…      â”‚
     â”‚                             â”‚                        â”‚
     â”‚                             â”‚  6. UPDATE call status â”‚
     â”‚                             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                             â”‚  CLOSED                â”‚
     â”‚                             â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                             â”‚  Call closed âœ…        â”‚
     â”‚                             â”‚                        â”‚
     â”‚  Response: 200 OK           â”‚                        â”‚
     â”‚  {ok:true, status:CLOSED... â”‚                        â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                        â”‚
     â”‚                             â”‚                        â”‚
     âœ… Display Success            âœ… All DB Changes Made
```

---

## ðŸš€ The Complete Sequence in Plain English

1. **Technician finishes the call work**
   - Has recorded all spares used
   - Has resolved any holds

2. **Technician sends Close Call request**
   - ```
     POST /api/technician-tracking/call/456/close
     {call_id: 456, technician_id: 501, status: "CLOSED"}
     ```

3. **System reads what spares were used**
   - Gets all records from call_spare_usage with used_qty > 0
   - Example: Spare 100 (qty 1), Spare 101 (qty 2)

4. **System creates stock movement**
   - Record showing: 3 units moved from GOOD to DEFECTIVE
   - Creates movement record in stock_movement table

5. **System creates detailed item records**
   - Records each spare individually
   - Both marked as "defective" condition

6. **System updates technician's inventory**
   - For each spare used:
     - Decreases qty_good
     - Increases qty_defective
   - Same location (technician 501), just different buckets

7. **System completes TAT tracking**
   - Sets tat_end_time to current time
   - Calculates total_tat_minutes
   - Updates tat_status to 'completed'

8. **System updates call status**
   - Sets call status from OPEN to CLOSED
   - Records timestamp

9. **System responds to client**
   - Status 200 (success)
   - Returns summary of what was done

10. **Database now shows:**
    - Call 456: CLOSED
    - Stock movement: 5001 (3 units GOODâ†’DEFECTIVE)
    - Inventory: Updated for both spares
    - TAT: Completed with total time

---

## âœ… That's It!

One API call â†’ All 6 database operations happen automatically and atomically.

**Next:** Verify results with the 5 SQL queries provided in the main guide.

